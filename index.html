<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>PDF Maker Pro - VersiÃ³n Ultra Estable</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #27ae60; --text: #e0e0e0; --error: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .toolbar { background: var(--card); padding: 10px 20px; border-radius: 12px; display: flex; gap: 8px; align-items: center; margin-bottom: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); border: 1px solid #333; position: sticky; top: 10px; z-index: 1000; }
        #canvas-container { position: relative; border: 2px solid #444; background: #555; line-height: 0; }
        #pdf-canvas { background: white; cursor: crosshair; }
        #selection-rect { position: absolute; border: 2px dashed var(--accent); background: rgba(39, 174, 96, 0.2); display: none; pointer-events: none; }
        .marker { position: absolute; background: rgba(39, 174, 96, 0.5); border: 2px solid var(--accent); pointer-events: none; color: white; font-weight: bold; font-size: 10px; display: flex; align-items: center; justify-content: center; }
        button, input, select { padding: 8px 12px; border-radius: 6px; border: 1px solid #444; background: #2c2c2c; color: white; font-weight: bold; cursor: pointer; }
        .btn-save { background: var(--accent); border: none; }
        .btn-undo { background: var(--error); border: none; }
        .page-ctrl { display: flex; align-items: center; gap: 10px; background: #000; padding: 5px 15px; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="toolbar">
        <input type="file" id="upload" accept="application/pdf">
        
        <div class="page-ctrl">
            <button onclick="changePage(-1)">â—€</button>
            <span> <span id="p-num">0</span> / <span id="p-tot">0</span> </span>
            <button onclick="changePage(1)">â–¶</button>
        </div>

        <select id="fieldType">
            <option value="text">Texto</option>
            <option value="check">Checkbox</option>
        </select>

        <button class="btn-undo" onclick="undo()">Deshacer</button>
        <button class="btn-save" onclick="savePDF()">ðŸ’¾ GUARDAR PDF</button>
    </div>

    <div id="canvas-container">
        <canvas id="pdf-canvas"></canvas>
        <div id="selection-rect"></div>
    </div>

<script>
    const pdfjs = window['pdfjs-dist/build/pdf'];
    pdfjs.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let rawData = null;
    let pdfDocInstance = null;
    let curP = 1;
    let fields = []; 
    let dragging = false;
    let sX, sY;

    const canvas = document.getElementById('pdf-canvas');
    const container = document.getElementById('canvas-container');
    const selRect = document.getElementById('selection-rect');

    // 1. Cargar archivo
    document.getElementById('upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const buffer = await file.arrayBuffer();
        rawData = new Uint8Array(buffer);
        
        pdfDocInstance = await pdfjs.getDocument({data: rawData}).promise;
        document.getElementById('p-tot').innerText = pdfDocInstance.numPages;
        fields = [];
        curP = 1;
        drawPage(curP);
    });

    async function drawPage(n) {
        if (!pdfDocInstance) return;
        document.getElementById('p-num').innerText = n;
        const page = await pdfDocInstance.getPage(n);
        const vp = page.getViewport({scale: 1.5});
        canvas.height = vp.height; canvas.width = vp.width;
        await page.render({canvasContext: canvas.getContext('2d'), viewport: vp}).promise;
        updateMarkers();
    }

    function changePage(d) {
        if (!pdfDocInstance) return;
        let n = curP + d;
        if (n > 0 && n <= pdfDocInstance.numPages) { curP = n; drawPage(curP); }
    }

    // 2. Dibujo
    canvas.addEventListener('mousedown', (e) => {
        if (!rawData) return;
        dragging = true;
        const r = canvas.getBoundingClientRect();
        sX = e.clientX - r.left; sY = e.clientY - r.top;
        selRect.style.display = 'block';
    });

    window.addEventListener('mousemove', (e) => {
        if (!dragging) return;
        const r = canvas.getBoundingClientRect();
        const cX = e.clientX - r.left; const cY = e.clientY - r.top;
        const w = cX - sX; const h = cY - sY;
        selRect.style.width = Math.abs(w) + 'px'; selRect.style.height = Math.abs(h) + 'px';
        selRect.style.left = (w > 0 ? sX : cX) + 'px'; selRect.style.top = (h > 0 ? sY : cY) + 'px';
    });

    window.addEventListener('mouseup', (e) => {
        if (!dragging) return;
        dragging = false; selRect.style.display = 'none';
        const r = canvas.getBoundingClientRect();
        const eX = e.clientX - r.left, eY = e.clientY - r.top;
        const w = Math.abs(eX - sX), h = Math.abs(eY - sY);

        if (w > 5 && h > 5) {
            fields.push({
                x: Math.min(sX, eX), y: Math.min(sY, eY), w, h,
                p: curP, t: document.getElementById('fieldType').value,
                cW: canvas.width, cH: canvas.height
            });
            updateMarkers();
        }
    });

    function updateMarkers() {
        document.querySelectorAll('.marker').forEach(m => m.remove());
        fields.filter(f => f.p === curP).forEach(f => {
            const m = document.createElement('div');
            m.className = 'marker';
            m.style.left = f.x + 'px'; m.style.top = f.y + 'px';
            m.style.width = f.w + 'px'; m.style.height = f.h + 'px';
            m.innerText = f.t === 'text' ? 'TXT' : 'V';
            container.appendChild(m);
        });
    }

    function undo() { fields.pop(); updateMarkers(); }

    // 3. GUARDADO (MOTOR DE CLONACIÃ“N)
    async function savePDF() {
        if (!rawData) return alert("Sube un PDF primero");
        try {
            const { PDFDocument } = PDFLib;
            
            // Cargamos el PDF original
            const srcDoc = await PDFDocument.load(rawData, { ignoreEncryption: true });
            
            // CREAMOS UN PDF NUEVO DESDE CERO (Para limpiar protecciones)
            const outDoc = await PDFDocument.create();
            
            // Copiamos todas las pÃ¡ginas al nuevo documento
            const pagesToCopy = Array.from({ length: srcDoc.getPageCount() }, (_, i) => i);
            const copiedPages = await outDoc.copyPages(srcDoc, pagesToCopy);
            copiedPages.forEach((page) => outDoc.addPage(page));

            const form = outDoc.getForm();
            const outPages = outDoc.getPages();

            fields.forEach((f, i) => {
                const page = outPages[f.p - 1];
                const { width, height } = page.getSize();
                const pX = (f.x * width) / f.cW;
                const pY = height - ((f.y * height) / f.cH) - ((f.h * height) / f.cH);
                const pW = (f.w * width) / f.cW;
                const pH = (f.h * height) / f.cH;

                const name = `f_${f.p}_${i}_${Math.floor(Math.random()*1000)}`;
                if (f.t === 'text') {
                    form.createTextField(name).addToPage(page, { x: pX, y: pY, width: pW, height: pH });
                } else {
                    form.createCheckBox(name).addToPage(page, { x: pX, y: pY, width: pW, height: pH });
                }
            });

            const bytes = await outDoc.save();
            const blob = new Blob([bytes], { type: "application/pdf" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "pdf_rellenable_limpio.pdf";
            a.click();
            URL.revokeObjectURL(url);
        } catch (err) {
            console.error(err);
            alert("Error al guardar. Si el PDF tiene firmas digitales, no se puede editar por seguridad.");
        }
    }
</script>
</body>
</html>
