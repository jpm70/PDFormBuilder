<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>PDF Maker Pro - MultipÃ¡gina</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #27ae60; --text: #e0e0e0; --error: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .toolbar { 
            background: var(--card); padding: 15px 25px; border-radius: 12px; 
            display: flex; gap: 10px; align-items: center; margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5); border: 1px solid #333;
            position: sticky; top: 10px; z-index: 1000; flex-wrap: wrap; justify-content: center;
        }

        #canvas-container { position: relative; border: 2px solid #444; box-shadow: 0 0 20px rgba(0,0,0,0.3); line-height: 0; overflow: hidden; }
        #pdf-canvas { background: white; cursor: crosshair; }
        
        #selection-rect {
            position: absolute; border: 2px dashed var(--accent);
            background: rgba(39, 174, 96, 0.2); display: none; pointer-events: none;
        }

        .marker { 
            position: absolute; background: rgba(39, 174, 96, 0.4); 
            border: 2px solid var(--accent); pointer-events: none; 
            color: white; font-weight: bold; font-size: 10px; display: flex; 
            align-items: center; justify-content: center; overflow: hidden;
        }

        button, input, select { 
            padding: 10px 14px; border-radius: 8px; border: 1px solid #444; 
            background: #2c2c2c; color: white; font-weight: 600; cursor: pointer;
        }

        button:hover { background: #3d3d3d; }
        .btn-save { background: var(--accent); border: none; }
        .btn-clear { background: #555; border: none; }
        .btn-undo { background: var(--error); border: none; }

        .page-ctrl { display: flex; align-items: center; gap: 10px; background: #2c2c2c; padding: 5px 15px; border-radius: 8px; border: 1px solid #444; }
    </style>
</head>
<body>

    <div class="toolbar">
        <input type="file" id="upload" accept="application/pdf">
        
        <div class="page-ctrl">
            <button onclick="changePage(-1)">â—€</button>
            <span>PÃ¡g: <span id="page-num">0</span> / <span id="page-count">0</span></span>
            <button onclick="changePage(1)">â–¶</button>
        </div>

        <select id="fieldType">
            <option value="text">Texto</option>
            <option value="check">Checkbox</option>
        </select>

        <button class="btn-undo" onclick="undoLast()">Deshacer</button>
        <button class="btn-clear" onclick="clearAll()">Limpiar Todo</button>
        <button class="btn-save" onclick="generatePDF()">ðŸ’¾ Guardar PDF</button>
    </div>

    <div id="canvas-container">
        <canvas id="pdf-canvas"></canvas>
        <div id="selection-rect"></div>
    </div>

<script>
    const pdfjs = window['pdfjs-dist/build/pdf'];
    pdfjs.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pdfData = null;
    let pdfDocInstance = null;
    let currentPage = 1;
    let fieldPoints = []; // Ahora guardarÃ¡ tambiÃ©n el nÃºmero de pÃ¡gina
    let isDragging = false;
    let startX, startY;

    const canvas = document.getElementById('pdf-canvas');
    const container = document.getElementById('canvas-container');
    const selRect = document.getElementById('selection-rect');

    // 1. CARGAR PDF
    document.getElementById('upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const arrayBuffer = await file.arrayBuffer();
        pdfData = new Uint8Array(arrayBuffer);
        
        pdfDocInstance = await pdfjs.getDocument({data: pdfData}).promise;
        document.getElementById('page-count').innerText = pdfDocInstance.numPages;
        
        fieldPoints = [];
        currentPage = 1;
        renderPage(currentPage);
    });

    async function renderPage(num) {
        if (!pdfDocInstance) return;
        document.getElementById('page-num').innerText = num;
        
        const page = await pdfDocInstance.getPage(num);
        const viewport = page.getViewport({scale: 1.5});
        
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        await page.render({canvasContext: canvas.getContext('2d'), viewport: viewport}).promise;
        renderMarkers();
    }

    function changePage(delta) {
        if (!pdfDocInstance) return;
        const newPage = currentPage + delta;
        if (newPage > 0 && newPage <= pdfDocInstance.numPages) {
            currentPage = newPage;
            renderPage(currentPage);
        }
    }

    // 2. DIBUJO
    canvas.addEventListener('mousedown', (e) => {
        if (!pdfData) return;
        isDragging = true;
        const rect = canvas.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        selRect.style.display = 'block';
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const rect = canvas.getBoundingClientRect();
        const curX = e.clientX - rect.left;
        const curY = e.clientY - rect.top;
        const w = curX - startX;
        const h = curY - startY;
        selRect.style.width = Math.abs(w) + 'px';
        selRect.style.height = Math.abs(h) + 'px';
        selRect.style.left = (w > 0 ? startX : curX) + 'px';
        selRect.style.top = (h > 0 ? startY : curY) + 'px';
    });

    window.addEventListener('mouseup', (e) => {
        if (!isDragging) return;
        isDragging = false;
        selRect.style.display = 'none';
        const rect = canvas.getBoundingClientRect();
        const endX = e.clientX - rect.left, endY = e.clientY - rect.top;
        const w = Math.abs(endX - startX), h = Math.abs(endY - startY);

        if (w > 10 && h > 10) {
            fieldPoints.push({
                x: Math.min(startX, endX), y: Math.min(startY, endY),
                w, h, page: currentPage, type: document.getElementById('fieldType').value,
                cW: canvas.width, cH: canvas.height
            });
            renderMarkers();
        }
    });

    function renderMarkers() {
        document.querySelectorAll('.marker').forEach(m => m.remove());
        fieldPoints.filter(p => p.page === currentPage).forEach(p => {
            const div = document.createElement('div');
            div.className = 'marker';
            div.style.left = p.x + 'px'; div.style.top = p.y + 'px';
            div.style.width = p.w + 'px'; div.style.height = p.h + 'px';
            div.innerText = p.type === 'text' ? 'TXT' : 'CHK';
            container.appendChild(div);
        });
    }

    function undoLast() { fieldPoints.pop(); renderMarkers(); }
    function clearAll() { if(confirm("Â¿Borrar todos los campos?")) { fieldPoints = []; renderMarkers(); } }

    // 3. GUARDAR
    async function generatePDF() {
        if (!pdfData) return alert("Sube un PDF primero");
        try {
            const pdfDoc = await PDFLib.PDFDocument.load(pdfData);
            const form = pdfDoc.getForm();
            const pages = pdfDoc.getPages();

            fieldPoints.forEach((p, i) => {
                const targetPage = pages[p.page - 1];
                const { width, height } = targetPage.getSize();
                
                const pdfX = (p.x * width) / p.cW;
                const pdfY = height - ((p.y * height) / p.cH) - ((p.h * height) / p.cH);
                const pdfW = (p.w * width) / p.cW;
                const pdfH = (p.h * height) / p.cH;

                if (p.type === 'text') {
                    form.createTextField(`f${i}_${Date.now()}`).addToPage(targetPage, { x: pdfX, y: pdfY, width: pdfW, height: pdfH });
                } else {
                    form.createCheckBox(`c${i}_${Date.now()}`).addToPage(targetPage, { x: pdfX, y: pdfY, width: pdfW, height: pdfH });
                }
            });

            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: "application/pdf" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "formulario_completo.pdf";
            link.click();
        } catch (err) { alert("Error al procesar. Intenta con otro PDF."); }
    }
</script>
</body>
</html>
