<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>PDF Maker Pro - Estable</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #27ae60; --text: #e0e0e0; --error: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .toolbar { 
            background: var(--card); padding: 15px 25px; border-radius: 12px; 
            display: flex; gap: 15px; align-items: center; margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5); border: 1px solid #333;
            position: sticky; top: 20px; z-index: 1000;
        }

        #canvas-container { position: relative; border: 2px solid #444; box-shadow: 0 0 20px rgba(0,0,0,0.3); line-height: 0; }
        #pdf-canvas { background: white; cursor: crosshair; }
        
        #selection-rect {
            position: absolute; border: 2px dashed var(--accent);
            background: rgba(39, 174, 96, 0.2); display: none; pointer-events: none;
        }

        .marker { 
            position: absolute; background: rgba(39, 174, 96, 0.4); 
            border: 2px solid var(--accent); pointer-events: none; 
            color: white; font-weight: bold; font-size: 10px; display: flex; 
            align-items: center; justify-content: center; overflow: hidden; white-space: nowrap;
        }

        button, input[type="file"], select { 
            padding: 10px 16px; border-radius: 8px; border: 1px solid #444; 
            background: #2c2c2c; color: white; font-weight: 600; cursor: pointer;
        }

        button:hover { background: #3d3d3d; }
        .btn-save { background: var(--accent); border: none; }
        .btn-undo { background: var(--error); border: none; }

        .hint { margin-top: 15px; font-size: 0.9em; color: #888; text-align: center; }
    </style>
</head>
<body>

    <div class="toolbar">
        <input type="file" id="upload" accept="application/pdf">
        <select id="fieldType">
            <option value="text">Campo de Texto</option>
            <option value="check">Casilla (Checkbox)</option>
        </select>
        <button class="btn-undo" onclick="undoLast()">â†© Deshacer</button>
        <button class="btn-save" onclick="generatePDF()">ðŸ’¾ Guardar PDF</button>
    </div>

    <div id="canvas-container">
        <canvas id="pdf-canvas"></canvas>
        <div id="selection-rect"></div>
    </div>

    <div class="hint">
        1. Sube un PDF. <br>
        2. <b>Haz clic y arrastra</b> para dibujar el cuadro. <br>
        3. Usa "Deshacer" si te equivocas.
    </div>

<script>
    const pdfjs = window['pdfjs-dist/build/pdf'];
    pdfjs.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let originalUint8Array = null;
    let fieldPoints = [];
    let isDragging = false;
    let startX, startY;

    const canvas = document.getElementById('pdf-canvas');
    const container = document.getElementById('canvas-container');
    const selRect = document.getElementById('selection-rect');

    // 1. CARGAR PDF (CON UNINT8ARRAY PERSISTENTE)
    document.getElementById('upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const arrayBuffer = await file.arrayBuffer();
        originalUint8Array = new Uint8Array(arrayBuffer); // Guardamos la copia globalmente
        
        const pdf = await pdfjs.getDocument({data: originalUint8Array}).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({scale: 1.5});
        
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        await page.render({canvasContext: canvas.getContext('2d'), viewport: viewport}).promise;
        
        fieldPoints = [];
        renderMarkers();
    });

    // 2. LÃ“GICA DE DIBUJO POR ARRASTRE
    canvas.addEventListener('mousedown', (e) => {
        if (!originalUint8Array) return;
        isDragging = true;
        const rect = canvas.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        
        selRect.style.left = startX + 'px';
        selRect.style.top = startY + 'px';
        selRect.style.width = '0px';
        selRect.style.height = '0px';
        selRect.style.display = 'block';
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const rect = canvas.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        const width = currentX - startX;
        const height = currentY - startY;

        selRect.style.width = Math.abs(width) + 'px';
        selRect.style.height = Math.abs(height) + 'px';
        selRect.style.left = (width > 0 ? startX : currentX) + 'px';
        selRect.style.top = (height > 0 ? startY : currentY) + 'px';
    });

    window.addEventListener('mouseup', (e) => {
        if (!isDragging) return;
        isDragging = false;
        selRect.style.display = 'none';

        const rect = canvas.getBoundingClientRect();
        const endX = e.clientX - rect.left;
        const endY = e.clientY - rect.top;

        const width = Math.abs(endX - startX);
        const height = Math.abs(endY - startY);

        if (width > 10 && height > 10) {
            fieldPoints.push({
                x: Math.min(startX, endX),
                y: Math.min(startY, endY),
                w: width,
                h: height,
                type: document.getElementById('fieldType').value,
                cW: canvas.width,
                cH: canvas.height
            });
            renderMarkers();
        }
    });

    function renderMarkers() {
        document.querySelectorAll('.marker').forEach(m => m.remove());
        fieldPoints.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'marker';
            div.style.left = p.x + 'px';
            div.style.top = p.y + 'px';
            div.style.width = p.w + 'px';
            div.style.height = p.h + 'px';
            div.innerText = p.type === 'text' ? 'TEXTO' : 'CHECK';
            container.appendChild(div);
        });
    }

    function undoLast() {
        fieldPoints.pop();
        renderMarkers();
    }

    // 3. GENERAR PDF (ESTABLE)
    async function generatePDF() {
        if (!originalUint8Array) return alert("Error: Sube un archivo PDF primero.");
        if (fieldPoints.length === 0) return alert("Dibuja al menos un campo sobre el documento.");

        try {
            // Importante: Usamos una copia limpia de los bytes originales
            const pdfDoc = await PDFLib.PDFDocument.load(originalUint8Array);
            const form = pdfDoc.getForm();
            const page = pdfDoc.getPages()[0];
            const { width, height } = page.getSize();

            fieldPoints.forEach((p, i) => {
                const pdfX = (p.x * width) / p.cW;
                const pdfY = height - ((p.y * height) / p.cH) - ((p.h * height) / p.cH);
                const pdfW = (p.w * width) / p.cW;
                const pdfH = (p.h * height) / p.cH;

                if (p.type === 'text') {
                    const tf = form.createTextField(`f_${Date.now()}_${i}`);
                    tf.addToPage(page, { x: pdfX, y: pdfY, width: pdfW, height: pdfH });
                } else {
                    const cb = form.createCheckBox(`c_${Date.now()}_${i}`);
                    cb.addToPage(page, { x: pdfX, y: pdfY, width: pdfW, height: pdfH });
                }
            });

            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: "application/pdf" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "editado_rellenable.pdf";
            link.click();
        } catch (err) {
            console.error(err);
            alert("Error al procesar el documento. AsegÃºrate de que el PDF no estÃ© protegido.");
        }
    }
</script>
</body>
</html>
